# ROS сообщения

Сам по себе ROS включает огромное количество тематических сообщений. Существующие пакеты содержат как стандартные сообщения std_msgs, так и специальные сообщения, например, для данных датчиков sensor_msgs. Но иногда случается такое, что приходится создать свое сообщение, так как ни одно не подходит под требование к передаче данных. Для дальнейшего разбора возьмём за основу [офф страницу о создании сообщений и сервисов](http://wiki.ros.org/ROS/Tutorials/CreatingMsgAndSrv).

## Создание сообщения

Начало создания кастомного сообщения берется с создания папки msg в пакете. После этого внутри этой папки создаётся файл с расширением .msg и названием соответствующим названию желаемого сообщения.

Например, созданный файл (в дальнейшем собранный) Control.msg в пакете study_pkg будет представлять сообщение study_pkg/Control.

Содержимое будет представлять собой управление роботом с системой колес автомобильного типа и иметь следующий вид

```
int32 steer
int32 speed
```

В данном случае первое поле отражает в процентах угол поворота колес, а второе поле - задание скорости перемещения робота в процентах. Оба поля являются целочисленными и основываются на пакете std_msgs.

На этом создание сообщения закончено и можно перейти к сборке. Для этого необходимо отредактировать файл CMakeLists.txt внутри пакета.

## Сборка

Первое, что надо добавить в файл - поиск зависимостей, в нашем случае это пакет, на типах которого построено наше сообщение std_msgs. А также зависимость пакета для генерации сообщений message_generation
```cmake
find_package(
    catkin REQUIRED COMPONENTS 
    ... 
    std_msgs 
    message_generation 
)
```

После в макрос `catkin_package()` необходимо добавить зависимость, позволяющую использовать свои сообщения в работе
```cmake
catkin_package( 
    ... 
    CATKIN_DEPENDS message_runtime ... 
    ...
)
```

Далее макросом добавим файлы сообщений, которые требуется сгенерировать
```cmake
add_message_files( 
    FILES 
    ...
    Control.msg 
)
```

И вызвать макрос генерации сообщений с указанием зависимостей
```cmake
generate_messages( 
    DEPENDENCIES 
    ...
    std_msgs
)
```

После редактирования CMakeLists.txt его нужно сохранить.

Также необходимо отредактировать файл package.xml - добавить следующие строки в соответствующие блоки
```xml
  <build_depend>message_generation</build_depend>
  <exec_depend>message_runtime</exec_depend>
```

После файл package.xml сохраняется и можно вызвать `catkin_make` внутри ws, чтобы собрать сообщение.

## Проверка

Далее пользуясь утилитой `rosmsg` можно увидеть сообщение внутри нашего пакета
```bash
rosmsg package study_pkg
```

А также посмотреть содержимое сообщения
```bash
rosmsg show study_pkg/Control
```

или, если вы забыли название пакета, утилита сама найдет с помощью команды
```bash
rosmsg show Control
```

## Использование Python

Для использования нового сообщения в языке Python производится импорт модуля сообщения
```python
from study_pkg.msg import Control
```

Далее при необходимости публикации этого сообщения создается объект и заполняется
```python
msg = Control()

msg.steer = 40
msg.speed = 10
```

или
```python
msg = Control(steer=40, speed=10)
```

При подписке на топик с новым сообщением работа происходит аналогично
```python
def topic_cb(msg):
    print(msg.speed, msg.steer)
    
```

## Использование C++

Подключаем заголовок с новым сообщением
```cpp
#include <study_pkg/Control.h>
```

Создание объекта сообщения и заполнение
```cpp
study_pkg::Control msg;

msg.steer = 20;
msg.speed = 10;
```

Обработка в callback функции при подписке
```cpp
void topicCallback(const study_pkg::Control::ConstPtr& msg)
{
  ROS_INFO("Speed: %d / Steer: %d", msg->speed, msg->steer);
}
```

> Напишите узлы, которые передают данные через топик с новым сообщением. Напишите launch-файл для их запуска. С помощью утилит в терминале проверьте их работоспособность.

## В результате

- Был рассмотрен процесс создания собственных сообщений и рассмотрены основные моменты их использования.
